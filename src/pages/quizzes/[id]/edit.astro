---
import Layout from "../../../layouts/Layout.astro";

import { QuizEditView } from "../../../components/QuizEditView";

import type { QuizDetailDTO } from "../../../types";

import { logger } from "../../../lib/services/logger.service";

// Konfiguracja dla hybrid rendering - ta strona będzie server-side rendered

export const prerender = false;

// Pobranie danych quizu po stronie serwera

const { id } = Astro.params;

let quiz: QuizDetailDTO | null = null;

let error: string | null = null;

if (!id || typeof id !== "string") {
  error = "Nieprawidłowy identyfikator quizu";
} else {
  try {
    const response = await fetch(`${Astro.url.origin}/api/quizzes/${id}`);

    if (response.ok) {
      quiz = await response.json();
    } else if (response.status === 404) {
      error = "Quiz nie został znaleziony";
    } else {
      error = "Nie udało się pobrać danych quizu";

      logger.error("Failed to fetch quiz", {
        error: {
          message: `HTTP ${response.status}: ${response.statusText}`,

          details: { status: response.status, quizId: id },
        },

        quizId: id,
      });
    }
  } catch (e) {
    error = "Błąd połączenia z serwerem";

    logger.error("Failed to fetch quiz", {
      error: {
        message: e instanceof Error ? e.message : String(e),

        stack: e instanceof Error ? e.stack : undefined,

        details: { quizId: id },
      },

      quizId: id,
    });
  }
}
---

<Layout title={`Edycja Quizu - ${quiz?.title || "QuizCards"}`}>
  {
    error ? (
      <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center py-12">
          <p class="text-destructive text-lg mb-2">{error}</p>

          <p class="text-muted-foreground text-sm">
            <a href="/" class="text-primary hover:underline">
              Powrót do panelu głównego
            </a>
          </p>
        </div>
      </div>
    ) : quiz ? (
      <QuizEditView client:load initialQuiz={quiz} />
    ) : null
  }
</Layout>
