---
import Layout from "../layouts/Layout.astro";
import { Dashboard } from "../components/Dashboard";
import type { QuizzesListDTO } from "../types";
import { logger } from "../lib/services/logger.service";

// Konfiguracja dla hybrid rendering - ta strona będzie server-side rendered
export const prerender = false;

// Pobranie listy quizów po stronie serwera
let quizzes: QuizzesListDTO = [];
let error: string | null = null;

try {
  /**
   * Forward cookies manually so the API sees the active user session
   * and does not redirect to /login (which would break JSON parsing).
   */
  const response = await fetch(new URL("/api/quizzes", Astro.url), {
    headers: {
      cookie: Astro.request.headers.get("cookie") ?? "",
    },
  });

  if (response.ok) {
    quizzes = await response.json();
  } else {
    error = "Nie udało się pobrać listy quizów";
    logger.error("Failed to fetch quizzes", {
      error: {
        message: `HTTP ${response.status}: ${response.statusText}`,
        details: { status: response.status },
      },
    });
  }
} catch (e) {
  error = "Błąd połączenia z serwerem";
  logger.error("Failed to fetch quizzes", {
    error: {
      message: e instanceof Error ? e.message : String(e),
      stack: e instanceof Error ? e.stack : undefined,
    },
  });
}
---

<Layout title="QuizCards - Panel Główny">
  {
    error ? (
      <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center py-12">
          <p class="text-destructive text-lg mb-2">{error}</p>
          <p class="text-muted-foreground text-sm">Odśwież stronę, aby spróbować ponownie</p>
        </div>
      </div>
    ) : (
      <Dashboard client:load initialQuizzes={quizzes} />
    )
  }
</Layout>
